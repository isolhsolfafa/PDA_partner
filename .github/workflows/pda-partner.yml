name: PDA Partner Automation

on:
  schedule:
    # ë§¤ì¼ ì˜¤í›„ 2ì‹œ (KST ê¸°ì¤€)
    - cron: '0 5 * * *'  # UTC ì˜¤ì „ 5ì‹œ = KST ì˜¤í›„ 2ì‹œ
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      test_mode:
        description: 'Test Mode (true/false)'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'
      limit:
        description: 'Process Limit (number of spreadsheets)'
        required: false
        default: '1'
        type: string
      generate_graphs:
        description: 'Generate Graphs (auto/true/false)'
        required: false
        default: 'auto'
        type: choice
        options:
        - 'auto'
        - 'true'
        - 'false'

jobs:
  run-pda-partner:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y fonts-nanum fonts-nanum-coding fonts-nanum-extra
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run code quality checks
      run: |
        pip install black flake8 isort
        black --check --diff . || echo "âš ï¸ Black formatting issues found (continuing...)"
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || echo "âš ï¸ Critical flake8 issues found (continuing...)"
        isort --check-only --diff . || echo "âš ï¸ Import sorting issues found (continuing...)"
        
    - name: Create Google API credentials
      run: |
        mkdir -p config
        
        # í™˜ê²½ë³€ìˆ˜ë¡œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
        echo "ðŸ” Processing SHEETS_SERVICE_ACCOUNT_KEY..."
        echo "$SHEETS_KEY" | tr -d ' \n\r\t' > /tmp/sheets_b64_clean.txt
        echo "Cleaned Base64 length: $(wc -c < /tmp/sheets_b64_clean.txt)"
        
        echo "ðŸ” Processing DRIVE_SERVICE_ACCOUNT_KEY..."
        echo "$DRIVE_KEY" | tr -d ' \n\r\t' > /tmp/drive_b64_clean.txt
        echo "Cleaned Base64 length: $(wc -c < /tmp/drive_b64_clean.txt)"
        
        # Base64 ë””ì½”ë”©
        echo "ðŸ”“ Decoding base64 strings..."
        base64 -d /tmp/sheets_b64_clean.txt > /tmp/sheets_raw.json 2>/dev/null || {
          echo "âŒ Failed to decode SHEETS_SERVICE_ACCOUNT_KEY"
          exit 1
        }
        
        base64 -d /tmp/drive_b64_clean.txt > /tmp/drive_raw.json 2>/dev/null || {
          echo "âŒ Failed to decode DRIVE_SERVICE_ACCOUNT_KEY"
          exit 1
        }
        
        # JSON ìˆ˜ì • ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
        echo "ðŸ”§ Creating JSON fix script..."
        cat > /tmp/fix_json.py << 'EOF'
        import json
        import sys
        import re
        
        def fix_json_file(input_file, output_file):
            try:
                with open(input_file, 'r') as f:
                    content = f.read()
                
                # private_key í•„ë“œì˜ ì‹¤ì œ ì¤„ë°”ê¿ˆì„ \\nìœ¼ë¡œ ë³€í™˜
                # ì •ê·œì‹ìœ¼ë¡œ private_key ë‚´ìš© ì°¾ê¸°
                pattern = r'"private_key":\s*"([^"]+)"'
                match = re.search(pattern, content, re.DOTALL)
                
                if match:
                    private_key = match.group(1)
                    # ì‹¤ì œ ì¤„ë°”ê¿ˆì„ \\nìœ¼ë¡œ ë³€í™˜
                    fixed_private_key = private_key.replace('\n', '\\n')
                    content = content.replace(match.group(1), fixed_private_key)
                
                # JSON íŒŒì‹± í…ŒìŠ¤íŠ¸
                data = json.loads(content)
                
                # íŒŒì¼ ì €ìž¥
                with open(output_file, 'w') as f:
                    json.dump(data, f, indent=2)
                
                return True
                
            except Exception as e:
                print(f"Error fixing JSON: {e}")
                return False
        
        if __name__ == "__main__":
            input_file = sys.argv[1]
            output_file = sys.argv[2]
            
            if fix_json_file(input_file, output_file):
                print(f"âœ… JSON fixed and saved: {output_file}")
            else:
                print(f"âŒ Failed to fix JSON: {input_file}")
                # ì›ë³¸ ê·¸ëŒ€ë¡œ ë³µì‚¬
                import shutil
                shutil.copy(input_file, output_file)
                sys.exit(1)
        EOF
        
        # JSON íŒŒì¼ ìˆ˜ì •
        echo "ðŸ”§ Fixing JSON files..."
        python /tmp/fix_json.py /tmp/sheets_raw.json config/sheets-service-account.json
        python /tmp/fix_json.py /tmp/drive_raw.json config/drive-service-account.json
        
        # ê²°ê³¼ í™•ì¸
        echo "âœ… Files created:"
        ls -la config/
        
        echo "ðŸ” File sizes:"
        wc -c config/*.json
        
        # JSON ìœ íš¨ì„± ê²€ì‚¬
        echo "ðŸ” Final validation..."
        
        if python -c "import json; json.load(open('config/sheets-service-account.json'))" 2>/dev/null; then
          echo "âœ… Sheets JSON is valid"
        else
          echo "âŒ Sheets JSON is still invalid"
          head -c 200 config/sheets-service-account.json
          exit 1
        fi
        
        if python -c "import json; json.load(open('config/drive-service-account.json'))" 2>/dev/null; then
          echo "âœ… Drive JSON is valid"
        else
          echo "âŒ Drive JSON is still invalid"
          head -c 200 config/drive-service-account.json
          exit 1
        fi
        
        # ìž„ì‹œ íŒŒì¼ ì •ë¦¬
        rm -f /tmp/sheets_b64_clean.txt /tmp/drive_b64_clean.txt /tmp/sheets_raw.json /tmp/drive_raw.json /tmp/fix_json.py
        
      env:
        SHEETS_KEY: ${{ secrets.SHEETS_SERVICE_ACCOUNT_KEY }}
        DRIVE_KEY: ${{ secrets.DRIVE_SERVICE_ACCOUNT_KEY }}
        
    - name: Set up environment variables
      run: |
        echo "SHEETS_KEY_PATH=./config/sheets-service-account.json" >> $GITHUB_ENV
        echo "DRIVE_KEY_PATH=./config/drive-service-account.json" >> $GITHUB_ENV
        echo "SPREADSHEET_ID=${{ secrets.SPREADSHEET_ID }}" >> $GITHUB_ENV
        echo "EMAIL_ADDRESS=${{ secrets.EMAIL_ADDRESS }}" >> $GITHUB_ENV
        echo "EMAIL_PASS=${{ secrets.EMAIL_PASS }}" >> $GITHUB_ENV
        echo "RECEIVER_EMAIL=${{ secrets.RECEIVER_EMAIL }}" >> $GITHUB_ENV
        echo "KAKAO_REST_API_KEY=${{ secrets.KAKAO_REST_API_KEY }}" >> $GITHUB_ENV
        echo "KAKAO_ACCESS_TOKEN=${{ secrets.KAKAO_ACCESS_TOKEN }}" >> $GITHUB_ENV
        echo "KAKAO_REFRESH_TOKEN=${{ secrets.KAKAO_REFRESH_TOKEN }}" >> $GITHUB_ENV
        echo "GITHUB_TOKEN=${{ secrets.GH_TOKEN }}" >> $GITHUB_ENV
        echo "GITHUB_USERNAME=${{ secrets.GH_USERNAME }}" >> $GITHUB_ENV
        echo "GITHUB_REPO=${{ secrets.GH_REPO }}" >> $GITHUB_ENV
        echo "DRIVE_FOLDER_ID=${{ secrets.DRIVE_FOLDER_ID }}" >> $GITHUB_ENV
        echo "JSON_DRIVE_FOLDER_ID=${{ secrets.JSON_DRIVE_FOLDER_ID }}" >> $GITHUB_ENV
        echo "TARGET_SHEET_NAME=${{ secrets.TARGET_SHEET_NAME }}" >> $GITHUB_ENV
        echo "GITHUB_UPLOAD=${{ secrets.GH_UPLOAD }}" >> $GITHUB_ENV
        
        # ì›Œí¬í”Œë¡œìš° ìž…ë ¥ê°’ ì²˜ë¦¬
        if [ "${{ github.event.inputs.test_mode }}" != "" ]; then
          echo "TEST_MODE=${{ github.event.inputs.test_mode }}" >> $GITHUB_ENV
        else
          echo "TEST_MODE=false" >> $GITHUB_ENV
        fi
        
        if [ "${{ github.event.inputs.limit }}" != "" ]; then
          echo "LIMIT=${{ github.event.inputs.limit }}" >> $GITHUB_ENV
        else
          echo "LIMIT=1" >> $GITHUB_ENV
        fi
        
        if [ "${{ github.event.inputs.generate_graphs }}" != "" ]; then
          echo "GENERATE_GRAPHS=${{ github.event.inputs.generate_graphs }}" >> $GITHUB_ENV
        else
          echo "GENERATE_GRAPHS=auto" >> $GITHUB_ENV
        fi
        
    - name: Run PDA Partner
      run: |
        python PDA_partner.py
        
    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pda-partner-outputs
        path: |
          output/
          *.html
          *.png
          *.log
        retention-days: 7
        
    - name: Cleanup credentials
      if: always()
      run: |
        rm -f config/sheets-service-account.json
        rm -f config/drive-service-account.json 