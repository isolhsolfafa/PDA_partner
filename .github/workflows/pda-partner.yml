name: PDA Partner Daily Run

on:
  schedule:
    # ë§¤ì¼ ì˜¤í›„ 2ì‹œ (KST) = UTC ì˜¤ì „ 5ì‹œ
    - cron: '0 5 * * *'
  workflow_dispatch:
    inputs:
      limit:
        description: 'ì²˜ë¦¬í•  í•­ëª© ìˆ˜ (ê¸°ë³¸ê°’: 200)'
        required: false
        default: '200'
        type: string
      generate_graphs:
        description: 'ê·¸ë˜í”„ ìƒì„± (true/false)'
        required: false
        default: false
        type: boolean
      github_upload:
        description: 'GitHub ì—…ë¡œë“œ (true/false)'
        required: false
        default: true
        type: boolean

jobs:
  run-pda-partner:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y fonts-nanum fonts-nanum-coding fonts-nanum-extra
        # í°íŠ¸ ìºì‹œ ì—…ë°ì´íŠ¸
        fc-cache -fv
        # ì„¤ì¹˜ëœ í•œê¸€ í°íŠ¸ í™•ì¸
        fc-list | grep -i nanum
        
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Create Google service account keys
      run: |
        mkdir -p config
        
        # Sheets ì„œë¹„ìŠ¤ ê³„ì • í‚¤ ìƒì„±
        echo "${{ secrets.SHEETS_SERVICE_ACCOUNT_KEY }}" | base64 --decode > config/gst-manegemnet-70faf8ce1bff.json
        
        # Drive ì„œë¹„ìŠ¤ ê³„ì • í‚¤ ìƒì„±  
        echo "${{ secrets.DRIVE_SERVICE_ACCOUNT_KEY }}" | base64 --decode > config/gst-manegemnet-ab8788a05cff.json
        
        # íŒŒì¼ ìƒì„± í™•ì¸
        if [ -f "config/gst-manegemnet-70faf8ce1bff.json" ]; then
          echo "âœ… Sheets í‚¤ íŒŒì¼ ìƒì„± ì™„ë£Œ"
        else
          echo "âŒ Sheets í‚¤ íŒŒì¼ ìƒì„± ì‹¤íŒ¨"
          exit 1
        fi
        
        if [ -f "config/gst-manegemnet-ab8788a05cff.json" ]; then
          echo "âœ… Drive í‚¤ íŒŒì¼ ìƒì„± ì™„ë£Œ"
        else
          echo "âŒ Drive í‚¤ íŒŒì¼ ìƒì„± ì‹¤íŒ¨"
          exit 1
        fi
        
    - name: Run PDA Partner
      run: |
        echo "ğŸš€ PDA Partner ì‹¤í–‰ ì‹œì‘..."
        
        # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
        export SPREADSHEET_ID="${{ secrets.SPREADSHEET_ID }}"
        export TARGET_SHEET_NAME="${{ secrets.TARGET_SHEET_NAME }}"
        export DRIVE_FOLDER_ID="${{ secrets.DRIVE_FOLDER_ID }}"
        export JSON_DRIVE_FOLDER_ID="${{ secrets.JSON_DRIVE_FOLDER_ID }}"
        export GITHUB_TOKEN="${{ secrets.GH_TOKEN }}"
        export GITHUB_USERNAME="${{ secrets.GH_USERNAME }}"
        export GITHUB_REPO="${{ secrets.GH_REPO }}"
        export GITHUB_BRANCH="${{ secrets.GH_BRANCH }}"
        export KAKAO_REST_API_KEY="${{ secrets.KAKAO_REST_API_KEY }}"
        export KAKAO_ACCESS_TOKEN="${{ secrets.KAKAO_ACCESS_TOKEN }}"
        export KAKAO_REFRESH_TOKEN="${{ secrets.KAKAO_REFRESH_TOKEN }}"
        export EMAIL_ADDRESS="${{ secrets.EMAIL_ADDRESS }}"
        export EMAIL_PASS="${{ secrets.EMAIL_PASS }}"
        export RECEIVER_EMAIL="${{ secrets.RECEIVER_EMAIL }}"
        export SHEETS_KEY_PATH="config/gst-manegemnet-70faf8ce1bff.json"
        export DRIVE_KEY_PATH="config/gst-manegemnet-ab8788a05cff.json"
        
        # ì…ë ¥ê°’ ì²˜ë¦¬
        if [ "${{ github.event.inputs.limit }}" != "" ]; then
          export LIMIT="${{ github.event.inputs.limit }}"
        else
          export LIMIT="200"
        fi
        
        if [ "${{ github.event.inputs.generate_graphs }}" == "true" ]; then
          export GENERATE_GRAPHS="true"
        else
          export GENERATE_GRAPHS="false"
        fi
        
        if [ "${{ github.event.inputs.github_upload }}" == "true" ]; then
          export GITHUB_UPLOAD="true"
        else
          export GITHUB_UPLOAD="false"
        fi
        
        # ì‹¤í–‰
        python PDA_partner.py
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: pda-partner-results-${{ github.run_number }}
        path: |
          output/
          *.html
          *.log
        retention-days: 7 